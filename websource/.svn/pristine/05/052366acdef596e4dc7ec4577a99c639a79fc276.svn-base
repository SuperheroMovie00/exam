<?php
namespace Home\Controller;

//
//注释: Test - 测试信息
//
use Home\Controller\BasicController;
use Think\Log;
class TestController extends BasicController {

    public function _init() {
        $funcs = $this->getUserRoleList($this->user,array( 'Test', '/Home/Test', ));
        if ($funcs)
            $this->assign("rights",  $funcs);
        else{
            $funcs = array(
                         array("key"=>"refresh","func"=>"Test","Action"=>"refresh") ,
                         array("key"=>"import","func"=>"/Home/Test","Action"=>"import") ,
                         array("key"=>"save","func"=>"/Home/Test","Action"=>"save") ,
                         array("key"=>"search","func"=>"/Home/Test","Action"=>"view") ,
                         array("key"=>"detail_import","func"=>"/Home/Test","Action"=>"detail_import") ,
                         array("key"=>"detail_select","func"=>"/Home/Test","Action"=>"select_product") ,
                         array("key"=>"tabcaozuorizhi","func"=>"/Home/Test","Action"=>"tabcaozuorizhi") ,
                         array("key"=>"edit_base","func"=>"/Home/Test","Action"=>"edit_base") ,
                         array("key"=>"order_edit","func"=>"/Home/Test","Action"=>"edit_base") ,
                         array("key"=>"order_detail","func"=>"/Home/Test","Action"=>"detail_edit") ,
                         array("key"=>"order_delete","func"=>"/Home/Test","Action"=>"delete") ,
                         array("key"=>"grid","func"=>"/Home/Test","Action"=>"grid") ,
                         array("key"=>"status_on","func"=>"/Home/Test","Action"=>"status_on") ,
                         array("key"=>"status_off","func"=>"/Home/Test","Action"=>"status_off") ,
                         array("key"=>"master_view","func"=>"/Home/Test","Action"=>"view") ,
                         array("key"=>"master_edit","func"=>"/Home/Test","Action"=>"edit") ,
                         array("key"=>"master_delete","func"=>"/Home/Test","Action"=>"delete")
             );
            $this->assign("rights",  $this->GetUserRights($this->user["id"],$funcs ));
        }
        $this->assign("colshow", $this->GetUserColumnDefine($this->user["id"],"Test"));
    }

    public function index() {
      $data["pfuncid"] = I("request.pfuncid");
      $data["funcid"] = I("request.funcid");
      $data["zindex"] = I("request.zindex/d");
      if(empty($data["funcid"])) $data["funcid"] = "Test";
      $this->GetLastUrl($data["funcid"]);

      $func = I("request.func");
      if($func != "saveSelectProduct" && $func != "save") {
        $this->GetLastUrl($data["funcid"]);
      }

      switch ($func) {

//// case for add ////
        case "edit":
        case "edit_base":
        case "add":
          $this->add($data);
          break;
        case "save":
          $this->save($data);
          break;
//// case for import ////
        case "import":
          $this->import($data);
          break;
        case "import_save":
          $this->import_save($data);
          break;
//// case for grid ////
        case "detail_edit":
          $this->detail_edit($data);
          break;
        case "detail_del":
          $this->detail_del($data);
          break;
        case "detail_save":
          $this->detail_save($data);
          break;
//// case for status_on ////
        case "status_on":
          $this->status_on($data);
          break;
        case "status_on_save":
          $this->status_on_save($data);
          break;
//// case for status_off ////
        case "status_off":
          $this->status_off($data);
          break;
        case "status_off_save":
          $this->status_off_save($data);
          break;
//##combine_for_add_switch_case##

//// case for view ////
        case "view":
          $this->view($data);
          break;
        case "delete":
          $this->order_delete($data);
          break;
        case "detail_delete":
          $this->detail_delete($data);
          break;
        case "detail_add":
          $this->selectProduct($data);
          break;
        case "saveSelectProduct":
          $this->saveSelectProduct($data);
          break;
        default :
          $this->ajax_refresh($data ['funcid']);
          break;

      }
    }

//// source for add - begin ////
    private function add($data) {
       $id = I("request.id/d");
       if(!$id){
          //读接入参数
          $type = I("request.type");
          $category_code = I("request.category_code");
          $test_no = I("request.test_no");
          $name = I("request.name");
          $category_name = I("request.category_name");
          //赋初值
          $search["type"] = $type?$type:"0";  //第一个选项
          $search["category_code"] = $category_code?$category_code:"";
          $search["test_no"] = $test_no?$test_no:"";
          $search["name"] = $name?$name:"";
          $search["category_name"] = $category_name?$category_name:"";
       } else {
          $search = M(test)->find($id);
          if(!$search){
              $this->ajaxResult("测试数据不存在" );
          }
          $data["id"] = $search["id"];
       }
       $data["search"] = $search;
       foreach($data as $key=>$val) {
           $this->assign($key, $val);
       }
       $html = $this->fetch("Test:add");
       echo $html;
    }
    private function save($data) {
       $id=I("request.id/d" );
       //读取页面输入数据
       $type = I("request.type");
       $category_code = I("request.category_code");
       $test_no = I("request.test_no");
       $name = I("request.name");
       if($_FILES['img'] && $_FILES['img']['error']==0){
           $upload = new \Think\Upload();// 实例化上传类
           $upload->maxSize   =     3145728 ;// 设置附件上传大小
           $upload->exts      =     array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型
           $upload->rootPath  =     './Uploads/'; // 设置附件上传根目录
           $upload->savePath  =     ''; // 设置附件上传（子）目录
           // 上传文件
           $info = $upload->upload();
           $img=trim($upload->rootPath,'.').$info['img']['savepath'].$info['img']['savename'];
       }else{
           $img=false;
       }
       $category_name = I("request.category_name");
       //非页面输入字段
       $input = array();
       //数据有效性校验，非空/数值负数，范围/日期与今日比较
       //数据校验 - 必输项不能为空
       if(!verify_value($type,"empty","","")) $this->ajaxError("类型 不能为空");
       if(!verify_value($test_no,"empty","","")) $this->ajaxError("编码 不能为空");
       if(!verify_value($name,"empty","","")) $this->ajaxError("名称 不能为空");
       $model = M("test");
       //判断 test_no 是否重复建立
       $orig = $model->where("test_no='$test_no'".($id?" and id!=$id":""))->find();
       if ($orig) $this->ajaxError("编码 $test_no 已存在");
       //页面输入字段
       $input["type"] = $type;
       $input["category_code"] = $category_code;
       $input["test_no"] = $test_no;
       $input["name"] = $name;
       if($img!=false)
          $input["img"] = $img;
       $input["category_name"] = $category_name;
       $input["modify_user"] = session(C("USER_AUTH_KEY"));
       $input["modify_time"] =  date('Y-m-d H:i:s.n');
       $model->startTrans();
       $result=false;
       //需要存入日志的字段
       $needSave=array(
            'type'=>'类型',
            'category_code'=>'知识点码',
            'test_no'=>'编码',
            'name'=>'名称',
            'category_name'=>'知识点',
       );
       if(!$id) {
          //新增  建号操作
          $keycode = GenOrderNo("test");
          $count = $model->where (array("test_no" => $keycode))->count();
          if ($count > 0) {
             echo json_encode(array ("msg" => message ( "%1 %2 已存在", "测试", $keycode )) );
             die ();
          }
          $input["test_no"] = $keycode;
          $input["create_user"] = session(C("USER_AUTH_KEY"));
          $input["create_time"] = date('Y-m-d H:i:s.n');
          //新增数据 保存数据库
          $result = $id = $model->add($input);
          //建立操作日志
          $result = $result && createLogOrder('test',$id,'新增测试','',"*",'test_no');
       } else {
          //id存在时判断数据库内数据是否存在
          $orig=$model->where("id='%d'",array($id))->find();
          if(empty($orig)) {
               $this->ajaxError("测试数据不存在");
          }
          if($orig["status"]!="0"){
             $this->ajaxError("测试非编辑状态");
          }
          //按主键更新数据
          $result = $model->where("id = $id")->save($input);
          $isSaveLog=false;
          foreach ($needSave as $key=>$v) {
              if($orig[$key]!=$input[$key]) {
                  $isSaveLog=true;
                  break;
              }
          }
          if($isSaveLog){
            //建立操作日志
            $result = $result && createLogOrder('test',$id,'变更测试',$orig,'','','test_no',$needSave);
          }
       }
       if($result){
           $model->commit();
       }else{
           $model->rollback();
           echo json_encode(array("msg"=>message("测试保存发生错误")));
           die;
       }
       //完成后跳转
       $this->ajaxReturn($data ['pfuncid'],$data ['funcid'],"refresh", "","closepopup", 1 );
       //转到view页面
       $this->ajaxReturn("","",U("Test/index?func=view&id=$id&pfuncid=".$data ['pfuncid']), tabtitle('题库',$input["test_no"] ) );
       die;
    }
//// source for add - end ////
//// source for import - begin ////
    private function import($data){
      $data['orderid'] = I("get.id");
      foreach($data as $key=>$val) {
        $this->assign($key, $val);
      }
      $html = $this->fetch("Test:import");
      echo $html;
    }
    private function cattext($string, $txt)
    {
        if($string)$string.=",";
        return $string.$txt;
    }
    private function import_save($data)
    {
        $orderid = I("request.orderid/d");
        $file = $_FILES;
        /* ========================================== */
        /* 上传文件 - 判断文件类型csv读取内容         */
        /* ========================================== */
        if (empty($file)) {
            $this->ajaxResult("导入失败:请上传csv文件");
        }
        if (isset($file["import"]) && $file["import"]["error"] == 0) {
            if (is_uploaded_file($file['import']['tmp_name'])) {
                if (substr($file['import']['name'], -4) != ".csv") {
                    $this->ajaxResult("导入失败:请上传csv文件");
                }
            }
        }
        /* ==================================================== */
        /* 上传文件 - 标题行列内容、列数、标题行、数据起始行    */
        /* ==================================================== */
        $header = array(
            "type" => "类型",
            "category_code" => "知识点码",
            "test_no" => "编码",
            "name" => "名称",
            "category_name" => "知识点",
                       );
        $row_header = 1;
        $row_data = 2;
        $field = array_keys($header);
        $field_count = count($field);
        /* =========================== */
        /* 上传文件 - 读取内容         */
        /* =========================== */
        $h = fopen($file['import']['tmp_name'], 'r');
        $importdatas = array();
        $n = 1;
        while ($row = fgetcsv($h)) {
            if ($n < $row_header) {
                $n++;
                continue;
            }
            $num = count($row);
            if ($n == $row_header) {
                if ($field_count != $num) $this->ajaxResult("导入失败:标题列数与模板不一致");
            } else if ($num > $field_count) {
                $num = $field_count;
            }
            for ($i = 0; $i < $num; $i++) {
                if ($n == 1) continue;
                $importdatas[$n][$field[$i]] = mb_convert_encoding($row[$i], 'utf-8', 'gbk');
            }
            $n++;
        }
        fclose($h);
        if ($n < $row_data) $this->ajaxResult("导入失败:文件内没有数据");
        /* =========================== */
        /* 上传文件 - 标题校验         */
        /* =========================== */
        $err = "";
        foreach ($importdatas[$row_header] as $key => $value) {
            if ($header[$key] != $value) $err = $this->cattext($err, $value);
        }
        if ($err) $this->ajaxResult("导入失败:标题列[$err]与模板定义不一致");
        /* =========================== */
        /* 上传文件 - 数据校验         */
        /* =========================== */
        $i = 0;
        foreach ($importdatas as $k => $row) {
            if ($k >= $row_data) {
               $err_type = "";
               $err_empty = "";
               $err_exist = "";
               if(!verify_value($row["type"],"empty","","")) $err_empty=$this->cattext($err_empty, $header["type"]);
               if(!verify_value($row["test_no"],"empty","","")) $err_empty=$this->cattext($err_empty, $header["test_no"]);
               if(!verify_value($row["name"],"empty","","")) $err_empty=$this->cattext($err_empty, $header["name"]);
               if (strlen($row["type"])>0) {
               //数值类型校验
                  if (!verify_value($row["type"], "num"))
                      $err_type = $this->cattext($err_type, $header["type"]);
                  else
                      if ($row["type"] < 0) $err_exist = $this->cattext($err_exist, $header["type"] . "是负数");
               }
               if ($err_empty || $err_exist || $err_type) {
                   $err .= "第 " . ($i + $row_data) . " 行校验失败\n";
                   if ($err_empty) $err .= "    数据为空: " . $err_empty . "\n";
                   if ($err_exist) $err .= "    数据非法：" . $err_exist . "\n";
                   if ($err_type) $err .= "    类型非法: " . $err_type . "\n";
               }
           }
           $i++;
       }
       //判断 test_no 是否重复建立
       $i = 0;
       foreach ($importdatas as $k => $row) {
           if ($k >= $row_data){
               $j=0;
               foreach ($importdatas as $k1 => $row1) {
                  if ($k1 >= $row_data and $k1>$k ){
                     if($row["test_no"]==$row1["test_no"]){
                         $err .= "第 " . ($i + $row_data). " 与 " . ($j + $row_data). " 行 ".$header["test_no"] ."\n";
                     }
                  }
                  $j++;
               }
           }
           $i++;
       }
       if ($err) {
           $this->ajaxResult("数据重复:\n" . $err);
       }
       $model = M("test");
       //关键字重复导入覆盖方式
       $overwrite=true;
       if(!$overwrite){ //非覆盖方式检查是否重复
          //判断 test_no 是否重复建立
          $i = 0;
          foreach ($importdatas as $k => $row) {
             if ($k >= $row_data){
                $m = $model->where("test_no='".$row["test_no"]."'")->find();
                if ($m) $err .= "第 " . ($i + $row_data). " 行 ".$header["test_no"]."\n";
             }
             $i++;
          }
          if ($err) {
              $this->ajaxResult("数据存在:\n" . $err);
          }
       }
       /* =========================== */
       /* 上传文件 - 数据存储         */
       /* =========================== */
        $model->startTrans();
        $total=0;
        $new=0;
        $edit=0;
        foreach ($importdatas as $row) {
            $input = array();
            $id = 0;
            $m = array();
            //非导入字段-赋初值
            //导入字段
            $input["type"] = $row["type"];
            $input["category_code"] = $row["category_code"];
            $input["test_no"] = $row["test_no"];
            $input["name"] = $row["name"];
            $input["category_name"] = $row["category_name"];
            //modify_user/time字段
            $input["modify_user"] = session(C("USER_AUTH_KEY"));
            $input["modify_time"] =  date('Y-m-d H:i:s.n');
            //检查是否存在
            //样例 $m = $model->where("code='".$row["code"]."'")->find();
            $orig = $model->where("test_no='".$row["test_no"]."'")->find();
            if (!$orig) {
                  //新增
                $input["create_user"] = session(C("USER_AUTH_KEY"));
                $input["create_time"] =  date('Y-m-d H:i:s.n');
                $result = $id = $model->add($input);
                $new++;
                //建立操作日志
                    $result = $result && createLogOrder('test', $id, '数据导入(新增)',$orig,'','','test_no',$header);
            } else {
                  //覆盖
                $id = $orig['id'];
                $result = $model->where("id=$id")->save($input);
                $edit++;
                //建立操作日志
                $result = $result && createLogOrder('test',$id,'数据导入(覆盖)',$orig,'','','test_no',$header);
            }
            if (!$result) {
                break;
            }
            $total++;
        }
        if ($result) {
            $model->commit();
        } else {
            $model->rollback();
        }
        $this->ajax_hideConfirm();
        $this->ajax_closePopup($data ['funcid']);
        $this->ajax_refresh($data ['pfuncid']);
        $this->ajaxResult("本次导入 $total 条, 新增 $new 条, 覆盖 $edit 条");
        die;
        //$this->ajaxReturn($data ['pfuncid'], $data ['funcid'], "refresh", "", "closepopup");
    }
//// source for import - end ////
//// source for grid - begin ////
    private function detail_edit($data) {
        //_pid 主档表  的id
        $id = I("request.id");
        if (!$id) {
            $this->ajaxError("测试参数错误");
        }
        $master = M('test')->where("id='%d' and status=0", array($id))->find();
        if (!$master) {
            $this->ajaxError("测试不存在或非可编辑状态");
        }
        $data["search"]=$master;
        //如果对有主档权限控制，请在此进行处理
        //$this->checkCustomerTree($id);
        //if($this->user_shop_id && $this->user_shop_id!=$master["customer_id"]){
        //   $this->ajaxError("不能编辑他人订单");
        //}
        //检查主档内主要数据状态是否正确
        //$customer = M("customer")->where("id = " . $master["customer_id"] . " and status=1")->find();
        //if (!$customer) {
        //    $this->ajaxError("客户信息不存在或非有效状态");
        //}
        //$type=0 搜索test_detail  $type=1 
        $type = I("get.type/d");
        //_keyword默认搜索关键字
        $data["search"]["_keyword"] = I("get._keyword");
        //是否起始装载已提交的明细数据
        $data["search"]["loaddetail"] = I("get.loaddetail");
        $data["p"] = I("get.p/d");
        $data["zindex"]=I("get.zindex/d");
        $existdetail=0;
        $data["id"]=$id;
        $where = "";
        if($data["search"]["loaddetail"]==1) {
            $_keyword = "" ;
            if (!empty($data["search"]["_keyword"])) {
                $where .= " AND ($_keyword)";
            }
            //额外增加的搜索字段
            $data["page_size"] = I("get.pagesize/d");
            $data["page_size"] = $data["page_size"] <= 0 ? session("test-grid-PageSize") : $data["page_size"];
            if (!$data["page_size"]) {
                $data["page_size"] = 50;
            }
            session("test-grid-PageSize", $data["page_size"]);
            $pre = C("DB_PREFIX");
            $orderby = " ORDER BY p.id";
            $data["master"] = $master;
            $data["id"]=$id;
            $sql = "SELECT d.id as _did
                          ,d.typea
                          ,d.codea
                          ,d.namea
                          ,d.lastchanged ";
              if ($type == 1) {
                  $sql .= "FROM ".$pre."test_detail as d " .
                          "WHERE d.test_id='".$id."' ";
                  $orderby = " ORDER BY d.id";
              } else {
                  $sql .= "FROM ".$pre."test_detail as d " .
                          "WHERE d.test_id='".$id."' $where";
              }
            $count_sql = "SELECT count(1) AS cnt FROM (" . $sql . ") a";
            $sql .= $orderby;
            $count = 0;
            $count = M()->query($count_sql);
            $count = $count[0]["cnt"];
            $data["list_total"] = $count;
            if ($count < $data["page_size"])
                $tmp = 1;
            else {
                $tmp = intval($count / $data["page_size"]);
                if ($count % $data["page_size"] != 0) {
                    $tmp++;
                }
            }
            if (!$data["p"]) $data["p"] = 1;
            if ($data["p"] > $tmp) $data["p"] = $tmp;
            $sql .= " LIMIT " . (($data["p"] - 1) * $data["page_size"]) . ", " . $data["page_size"];
            $data["list"] = M()->query($sql);
            foreach($data["list"] as $k=>$v){
                  if($v['_did']) {
                      $existdetail=1;
                      break;
                  }
            }
            $pageClass = new \Think\Page($count, $data["page_size"]);
            $pageClass->rollPage = 8;
            $data["page"] = $pageClass->show_drp($data["funcid"], "编辑测试");
        }
        $data["search"]["loaddetail"]=1;
        $data["existdetail"]=$existdetail;
        foreach($data as $key=>$val) {
            $this->assign($key, $val);
        }
        $html = $this->fetch("Test:grid");
        echo $html;
    }
    private function detail_del($data) {
        $id = I("request.id");
        if (!$id) {
            $this->ajaxError("测试参数错误");
        }
        $model=M("test_detail");
        $master=M("test")->where("id='%d' and status=0", array($id))->find();
        if (!$master) {
            $this->ajaxError("测试不存在或非可编辑状态");
        }
        //如果对有主档权限控制，请在此进行处理
        //$this->checkCustomerTree($id);
        //if($this->user_shop_id && $this->user_shop_id!=$master["customer_id"]){
        //   $this->ajaxError("不能编辑他人订单");
        //}
        //检查主档内主要数据状态是否正确
        //$customer = M("customer")->where("id = " . $master["customer_id"] . " and status=1")->find();
        //if (!$customer) {
        //    $this->ajaxError("客户信息不存在或非有效状态");
        //}
        $del= I("post.del");
        if(empty($del)) {
            $this->ajaxError("删除信息不存在");
        }
        $model->startTrans();
        //删除
        $del_info="";
        foreach ($del  as $k=>$v)
        {
            $ret=$model->field("codea")->find($v);
            if($ret){
               $result = $model->delete($v);
                   if(!$result){
                       $this->ajaxError_func("明细数据删除失败",$data["funcid"]."_focus");
                   }
               $del_info.=($del_info?",":"").$ret['codea'];
            }
        }
        $retinfo="";
        //进行重新汇总
        $result = $this->detail_subtotal($id, $retinfo);
        if(!$result){
            $this->ajaxError_func("测试汇总失败",$data["funcid"]."_focus");
        }
        $content="删除[$del_info]";
        $result = createLogOrder('test',$id,'删除明细',$content);
        if(!$result){
            $this->ajaxError_func("创建测试日志失败",$data["funcid"]."_focus");
        }
        $model->commit();
        $this->ajax_openLink($data["pfuncid"]);
        $this->ajax_func($data["funcid"]."_clear()");
        $this->ajax_func($data["funcid"]."_show",$retinfo);
        $this->ajaxResult();
    }
    private function detail_save($data) {
        $id = I("request.id");
        $close = I("request.close");
        if (!$id) {
            $this->ajaxError("测试参数错误");
        }
        $model=M("test_detail");
        $master=M("test")->where("id='%d' and status=0", array($id))->find();
        if (!$master) {
            $this->ajaxError("测试不存在或非可编辑状态");
        }
        //如果对有主档权限控制，请在此进行处理
        //$this->checkCustomerTree($id);
        //if($this->user_shop_id && $this->user_shop_id!=$master["customer_id"]){
        //   $this->ajaxError("不能编辑他人订单");
        //}
        //检查主档内主要数据状态是否正确
        //$customer = M("customer")->where("id = " . $master["customer_id"] . " and status=1")->find();
        //if (!$customer) {
        //    $this->ajaxError("客户信息不存在或非有效状态");
        //}
        $_did= I("post._did");
        $_id= I("post._id");
        if(empty($_id)) {
            $this->ajaxError("明细信息不存在");
        }
        $model->startTrans();
        $result=false;
        $qty_total=0;
        $chg_info="";
        $add_info="";
        $del_info="";
        foreach ($_id  as $k=>$v)
        {
            $detail=array();
            $did=I("_did_".$v);
            if($did){
                $detail=$model->find($did);
                if(!$detail)  $this->ajaxError_func("明细信息不存在",$data["funcid"]."_focus");
            }
                //读取输入数据
                $typea=I("typea_".$v);
                $codea=I("codea_".$v);
                $namea=I("namea_".$v);
                $lastchanged=I("lastchanged_".$v);
                //输入数据进行校验
                if (strtotime($lastchanged) > time()) $this->ajaxError("更改时间 不能大于当前日期");
                //检查明细数据是否存在
                $cur_data=array();
                //复制 输入数据
                $cur_data['typea'] = $typea;
                $cur_data['codea'] = $codea;
                $cur_data['namea'] = $namea;
                $cur_data['lastchanged'] = $lastchanged;
                //复制 主档表 test 的字段
                $cur_data['test_id']=$id;
                $cur_data['test_no']=$master['test_no'];
                //明细表是否存在要计算
                //$cur_data['qty']=$qty*$packing_qty;
                //$cur_data['price']=$g['purchase_price'];
                //$cur_data['amount']=round($cur_data['qty']*$cur_data['price'],2);
                //数据更新
                if($detail){
                    $result = $model->where("id=".$detail['id'])->save($cur_data);
                    $chg_info.=($chg_info?",":"").$cur_data['codea'];
                }else{
                    $result = $model->add($cur_data);
                    if(!$result) $this->ajaxError_func("新增数据(".$cur_data['codea'].")失败",$data["funcid"]."_focus");
                    $add_info.=($add_info?",":"").$cur_data['codea'];
                }
        }
        //进行重新汇总
        $result = $this->detail_subtotal($id, $retinfo);
        if(!$result) $this->ajaxError_func("测试汇总失败",$data["funcid"]."_focus");
        $content=$add_info?"添加[$add_info]":"";
        if($chg_info) $content.=($content?", ":"")."变动[$chg_info]";
        if($del_info) $content.=($content?", ":"")."删除[$del_info]";
        $result = createLogOrder('test',$id,'明细编辑',$content);
        if(!$result) $this->ajaxError_func("创建测试日志失败",$data["funcid"]."_focus");
        $model->commit();
        if($close == "1") {
            $this->ajaxReturn($data["pfuncid"],$data["funcid"],"refresh");
        } else {
            $this->ajax_openLink($data["pfuncid"]);
            $this->ajax_func($data["funcid"]."_clear()");
            $this->ajax_func($data["funcid"]."_show",$retinfo);
            $this->ajaxResult();
        }
    }
    private function detail_subtotal($id, &$return ) {
        $detail = M("test_detail")
                   ->field('count(*) as cnt ' )
                   ->where("test_id=%d",array($id))
                   ->select();
/*
        $detail = M("test_detail")->where("test_id=%d",array($id))->select();
        $amount=0;
        $qty=0;
        $details=0;
        foreach ($detail as $k=>$v) {
            $qty+=$v['qty'];
            $amount+=$v['price']*$v['qty'];
            $details++;
        }
*/
        $result = M('test')
                     ->where("id='%d'",array($id))
                     ->save(array(
                                   'modify_time'=>date('Y-m-d H:i:s'),
                                   'modify_user'=>session(C("USER_AUTH_KEY")),
                            ));
        return $result;
    }
//// source for grid - end ////
//// source for status_on - begin ////
    private function status_on($data) {
        $id = I("request.id/d");
        if(!$id) {
             $this->ajaxResult("测试参数不存在");
        }
        $search = M('test')->find($id);
        if(!$search)
            $this->ajaxResult("测试不存在");
        if($search['status']=='7'){
            $this->ajaxResult("测试已取消");
        }
        if($search['status']!='0'){
            $this->ajaxResult("测试状态已变化，请重新处理");
        }
        $data["search"] = $search;
        $data["id"] = $data["search"]["id"];
        foreach($data as $key=>$val) {
            $this->assign($key, $val);
        }
        $html = $this->fetch("Test:status_on");
        echo $html;
    }
    private function status_on_save($data) {
       $id=I("request.id/d" );
       if(!$id) {
           $this->ajaxResult("测试参数不存在");
       }
       //id存在时判断数据库内数据是否存在
       $orig=M("test")->where("id='%d'",array($id))->find();
       if(empty($orig)) {
           $this->ajaxError("测试数据不存在");
       }
       if($orig['status']=='7'){
           $this->ajaxResult("测试已取消");
       }
       if($orig['status']!='0'){
           $this->ajaxResult("测试状态已变化，请重新处理");
       }
       $reason_tag=I("request.reason_tag" );
       $reason=I("request.reason" );
        $detailtable = M("test_detail")->where("test_id = $id")->find();
        if(empty($detailtable)) {
            $this->ajaxResult("测试明细数据不存在");
        }
       $statusdesc="状态[有效], ";
       $input["status"] = "1";  // "文本类型"
       $content=$statusdesc."备注: ";
       if($reason_tag){
            $content.=$reason_tag;
            if ($reason)$content.=", ".$reason;
       }else{
             $content.=$reason;
       }
       $input["modify_user"] = session(C("USER_AUTH_KEY"));
       $input["modify_time"] = date('Y-m-d H:i:s.n');
       $model = M("test");
       $model->startTrans();
       //按主键更新数据
       $result = $model->where("id = $id")->save($input);
       //建立操作日志
          $result = $result && createLogOrder('test',$id,'状态调整',$content);
       if($result){
           $model->commit();
       }else{
           $model->rollback();
           echo json_encode(array("msg"=>message("测试保存发生错误")));
           die;
       }
       //完成后关闭并刷新父窗口
       $this->ajaxReturn($data ['pfuncid'],$data ['funcid'],"refresh", "","closepopup");
       die;
    }
//// source for status_on - end ////
//// source for status_off - begin ////
    private function status_off($data) {
        $id = I("request.id/d");
        if(!$id) {
             $this->ajaxResult("测试参数不存在");
        }
        $search = M('test')->find($id);
        if(!$search)
            $this->ajaxResult("测试不存在");
        if($search['status']=='7'){
            $this->ajaxResult("测试已取消");
        }
        if($search['status']!='1'){
            $this->ajaxResult("测试状态已变化，请重新处理");
        }
        $data["search"] = $search;
        $data["id"] = $data["search"]["id"];
        foreach($data as $key=>$val) {
            $this->assign($key, $val);
        }
        $html = $this->fetch("Test:status_off");
        echo $html;
    }
    private function status_off_save($data) {
       $id=I("request.id/d" );
       if(!$id) {
           $this->ajaxResult("测试参数不存在");
       }
       //id存在时判断数据库内数据是否存在
       $orig=M("test")->where("id='%d'",array($id))->find();
       if(empty($orig)) {
           $this->ajaxError("测试数据不存在");
       }
       if($orig['status']=='7'){
           $this->ajaxResult("测试已取消");
       }
       if($orig['status']!='1'){
           $this->ajaxResult("测试状态已变化，请重新处理");
       }
       $reason_tag=I("request.reason_tag" );
       $reason=I("request.reason" );
       if(!($reason_tag.$reason)){
           $this->ajaxResult("测试状态回退，需注明原因");
       }
       $statusdesc="退回状态[无效], ";
       $input["status"] = "0";  // "文本类型"
       $content=$statusdesc."备注: ";
       if($reason_tag){
            $content.=$reason_tag;
            if ($reason)$content.=", ".$reason;
       }else{
             $content.=$reason;
       }
       $input["modify_user"] = session(C("USER_AUTH_KEY"));
       $input["modify_time"] = date('Y-m-d H:i:s.n');
       $model = M("test");
       $model->startTrans();
       //按主键更新数据
       $result = $model->where("id = $id")->save($input);
       //建立操作日志
          $result = $result && createLogOrder('test',$id,'状态调整',$content);
       if($result){
           $model->commit();
       }else{
           $model->rollback();
           echo json_encode(array("msg"=>message("测试保存发生错误")));
           die;
       }
       //完成后关闭并刷新父窗口
       $this->ajaxReturn($data ['pfuncid'],$data ['funcid'],"refresh", "","closepopup");
       die;
    }
//// source for status_off - end ////
//##combine_for_add_source##

//// source for status confirm ////

//// source for status view ////
    private function view($data) {
        $data["p"] = I("request.p/d");
        $data["pagesize"] = I("request.pagesize/d");

        $data["id"] = I("request.id/d");
        $data["no"] = I("request.no");
        if(!$data["id"] && !$data["no"]) {
           $this->ajaxError("测试信息查询参数非法");
        }

        //condition
        $condition="";
        $joinsql="";
        //select search fields
        $selectmasterfields="@test.*";



        $sql = table("select #selectfields# from @test  #join# Where #viewkey# #condition# #orderby#");
        if($data["id"])
           $viewkey=table("@test.id=$data[id]");
        else
           $viewkey=table("@test.test_no='$data[no]'");
        $sql = str_replace("#selectfields#",table($selectmasterfields),$sql);
        $sql = str_replace("#join#",$joinsql,$sql);
        $sql = str_replace("#viewkey#",$viewkey,$sql);
        $sql = str_replace("#condition#",$condition,$sql);
        $sql = str_replace("#orderby#","",$sql);
        $search = M()->query($sql);
        if(!$search){
           $this->ajaxError("测试信息信息不存在");
        }
        $data["search"] = current($search);


        //按tabsheet - 开始
        $data["id"] = $data["search"]["id"];
        $data["search"]["_tab"] = $this->tabsheet_check(I("request._tab"));
        $page_size=$data["pagesize"] ;//session("Test-".$data["search"]["_tab"]."-PageSize");
        switch($data["search"]["_tab"])
        {

          case "ceshimingxi":
               $data = $this->tab_ceshimingxi_test_detail($page_size,$data);
               break;
          case "caozuorizhi":
               $data = $this->tab_caozuorizhi_log_order($page_size,$data);
               break;

        }
        $data["search"]["_tab_".$data["search"]["_tab"]."_p"]=$data["p"];
        $data["search"]["_tab_".$data["search"]["_tab"]."_psize"]=$data["page_size"];
        //session("Test-".$data["search"]["_tab"]."-PageSize", $data["page_size"]);
        //按tabsheet - 结束

        foreach($data as $key=>$val) {
            $this->assign($key, $val);
        }
        $html = $this->fetch("Test:view");
        echo $html;
    }

    //按tabsheet子程序 - 开始

    private function tab_ceshimingxi_test_detail($tab_pagesize,$data)
    {
        $orderby="";
        $joinsql="";


        $condition = "" ;


        //select detail fields
        $selectfields="@test_detail.id ";
        $selectfields.=",@test_detail.typea ";
        $selectfields.=",@test_detail.codea ";
        $selectfields.=",@test_detail.namea ";

        $viewkey="@test_detail.test_id='".$data["search"]["id"]."'";
     if(!$viewkey)
           $this->ajaxError("查询参数非法");
     //      die;

        $page_size = $tab_pagesize;
        if (!$page_size) {
            $page_size = 10;
        }

        $count_sql = table("select count(*) as cnt from @test_detail  #join# where #viewkey# #condition#");
        $search_sql = table("select #selectfields# from @test_detail  #join# Where #viewkey# #condition# #orderby#");

        $viewkey = table($viewkey);
        $condition = table($condition);
        $orderby= table($orderby);
        $selectfields= table($selectfields);

        $count_sql = str_replace("#condition#",$condition,$count_sql);
        $count_sql = str_replace("#viewkey#",$viewkey,$count_sql);
        $count_sql = str_replace("#join#",$joinsql,$count_sql);

        $count = M()->query($count_sql);
        $count = $count[0]["cnt"];

        if($count < $page_size)
            $tmp = 1;
        else {
            $tmp = intval($count / $page_size);
            if($count % $page_size != 0) {
                $tmp++;
            }
        }
        if(!$data["p"]) {
            $data["p"] = 1;
        }
        if($data["p"] > $tmp) {
            $data["p"] = $tmp;
        }

        $sql = str_replace("#selectfields#",$selectfields,$search_sql);
        $sql = str_replace("#join#",$joinsql,$sql);
        $sql = str_replace("#viewkey#",$viewkey,$sql);
        $sql = str_replace("#condition#",$condition,$sql);
        $sql = str_replace("#orderby#",$orderby,$sql);
        $sql .= " LIMIT ". (($data["p"] - 1) * $page_size). ", $page_size";
        $data["list"] = M()->query($sql);
        $pageClass = new \Think\Page($count,$page_size);
        $pageClass->rollPage = 8;
        $data["page"] = $pageClass->show_drp($data["funcid"]);
        $data["page_size"] = $page_size;

        return $data;
    }

    private function tab_caozuorizhi_log_order($tab_pagesize,$data)
    {
        $orderby="";
        $joinsql="";


        $condition = "" ;


        //select detail fields
        $selectfields="@log_order.status ";
        $selectfields.=",@log_order.id ";
        $selectfields.=",@log_order.create_time ";
        $selectfields.=",@log_order.order_id ";
        $selectfields.=",@log_order.order_no ";
        $selectfields.=",@log_order.subject ";
        $selectfields.=",@log_order.details ";
        $selectfields.=",@log_order.qty ";
        $selectfields.=",@log_order.amount ";
        $selectfields.=",@log_order.content ";

        $viewkey="@log_order.order_id='".$data["search"]["id"]."'";
        $viewkey.=" and @log_order.type='test'";
     if(!$viewkey)
           $this->ajaxError("查询参数非法");
     //      die;

        $page_size = $tab_pagesize;
        if (!$page_size) {
            $page_size = 10;
        }

        $count_sql = table("select count(*) as cnt from @log_order  #join# where #viewkey# #condition#");
        $search_sql = table("select #selectfields# from @log_order  #join# Where #viewkey# #condition# #orderby#");
        $orderby="order by @log_order.id desc";

        $viewkey = table($viewkey);
        $condition = table($condition);
        $orderby= table($orderby);
        $selectfields= table($selectfields);

        $count_sql = str_replace("#condition#",$condition,$count_sql);
        $count_sql = str_replace("#viewkey#",$viewkey,$count_sql);
        $count_sql = str_replace("#join#",$joinsql,$count_sql);

        $count = M()->query($count_sql);
        $count = $count[0]["cnt"];

        if($count < $page_size)
            $tmp = 1;
        else {
            $tmp = intval($count / $page_size);
            if($count % $page_size != 0) {
                $tmp++;
            }
        }
        if(!$data["p"]) {
            $data["p"] = 1;
        }
        if($data["p"] > $tmp) {
            $data["p"] = $tmp;
        }

        $sql = str_replace("#selectfields#",$selectfields,$search_sql);
        $sql = str_replace("#join#",$joinsql,$sql);
        $sql = str_replace("#viewkey#",$viewkey,$sql);
        $sql = str_replace("#condition#",$condition,$sql);
        $sql = str_replace("#orderby#",$orderby,$sql);
        $sql .= " LIMIT ". (($data["p"] - 1) * $page_size). ", $page_size";
        $data["list"] = M()->query($sql);
        $pageClass = new \Think\Page($count,$page_size);
        $pageClass->rollPage = 8;
        $data["page"] = $pageClass->show_drp($data["funcid"]);
        $data["page_size"] = $page_size;

        return $data;
    }



    private function tabsheet_check($itab)
    {
        $idefault="ceshimingxi";
        switch($itab)
        {

          case "ceshimingxi":
          case "caozuorizhi":

              break;
          default:
              $itab=$idefault;
              break;
         }
        return $itab;
    }
    //按tabsheet子程序 - 结束

    private function deleteProcess($id) {
        $type=1;
        $smo=M('test')->where("id='%d'",array($id))->find();
        if(empty($smo)) {
            $this->ajaxResult("测试信息数据不存在");
        }
        if($smo['status']!=0){
            $this->ajaxResult("测试信息状态不能删除");
        }

        $result=true;
        $result = $result && createLogOrder('test',$id,($smo['status']?'取消信息':'删除记录'),'');
        if($smo['status']!=0){
            $result = $result && M('test')->where("id='%d'",array($id))->save(array('status'=>8,'cancel_time'=>date('Y-m-d H:i:s'),'cancel_status'=>1));
        }else{
            $result = $result && M('test')->where("id='%d'",array($id))->delete();
        }
        return $result;
    }

    private function order_delete($data) {

        $id=I("request.id/d" );
        $type=I("request.type/d" );
        if(!$id) {
             $this->ajaxResult("测试信息参数不存在");
        }

        $m=M();
        $m->startTrans();
        $r=$this->deleteProcess($id);
        if($r){
            $m->commit();
        }else{
            $m->rollback();
        }

        $this->ajax_hideConfirm();
        if(!$type){
            $this->ajax_closeTab($data ['funcid']);
        }
        $this->ajax_refresh($data ['pfuncid']);
        $this->ajaxResult();
        die;
    }

    private function detail_delete($data) {
        $data["id"] = I("request.id");

        if(!is_array($data["id"])){
            $data["id"]=array($data["id"]);
        }

        $model=M('test_detail');
        $model->startTrans();
        $result1=true;
        $orderid=0;
        $content='';
        foreach ($data["id"] as $v) {
            $pd_delete=$model->where("id='%d'",array($v))->find();
            if($orderid==0){
                $orderid=$pd_delete['test_id'];
            }
            $result1 = $model->where("id='%d'",array($v))->delete();

            //写日志
            $content.=getOrderChange(array(),array(),'test','删除商品['.$pd_delete['goods_no'].$pd_delete['goods_name'].']');

            if(!$result1){
                break;
            }
        }

        //重新汇总 数量/金额，具体程序具体调整
        $rpd=$model->where("test_id='%d'",array($orderid))->field('qty,price')->select();
        $amount=0;
        $qty_total=0;
        foreach ($rpd as $k=>$v) {
            $qty_total+=$v['qty'];
            $amount+=$v['price']*$v['qty'];
        }

        $result2=M('test')->where("id='%d'",array($orderid))->save(array('qty'=>$qty_total,'amount'=>$amount));

        $smo=M('test')->where("id='%d'",array($orderid))->find();
        if($smo['status']!=0){
            $result2=false;
        }

        $result1 = $result1 && createLogOrder('test',$orderid,'删除测试信息商品',$content);

        if($result1 && $result2){
            $model->commit();
        }else{
            $model->rollback();
        }
        $this->ajaxResult("", "",  array("_asr.openLink"), array("'','".$data["funcid"]."','刷新', 1"));
    }

    private function selectProduct($data) {

        $data["search"]["category_id"] = I("get.category_id/a");
        $data["search"]["name"] = I("get.name");
        $data["search"]["goods_no"] = I("get.goods_no");
        $data["search"]["namelike"] = I("get.namelike/d");
        $data["orderid"] = I("request.id");
        $data["p"] = I("get.p/d");

        $where = "where 1=1";
        if(!empty($data["search"]["category_id"])) {
            $where .= " AND category_id IN (" . join(",", $data["search"]["category_id"]) . ")";
        }

        if(!empty($data["search"]["name"])) {
            if($data["search"]["namelike"]) {
                $where .= " AND like '%" . $data["search"]["name"] . "%'";
            } else {
                $where .= " AND name = '" . $data["search"]["name"] . "'";
            }
        }

        if(!empty($data["search"]["goods_no"])) {
            $where .= " AND goods_no = '". $data["search"]["goods_no"] . "'";
        }

        $data["page_size"] = I("get.pagesize/d");
        $data["page_size"] = $data["page_size"] <= 0 ? session("selectProduct-PageSize") : $data["page_size"];
        if(!$data["page_size"]) {
            $data["page_size"] = 10;
        }
        //$data["page_size"] = 2;
        session("selectProduct-PageSize", $data["page_size"]);

        $pre = C("DB_PREFIX");
        $count_sql = "SELECT count(*) AS cnt FROM " .$pre ."goods $where";
        $count = M()->query($count_sql);
        $count = $count[0]["cnt"];

        if($count < $data["page_size"])
            $tmp = 1;
        else {
            $tmp = intval($count / $data["page_size"]);
            if($count % $data["page_size"] != 0) {
                $tmp++;
            }
        }
        if(!$data["p"]) {
            $data["p"] = 1;
        }

        if($data["p"] > $tmp) {
            $data["p"] = $tmp;
        }

        $sql = "SELECT g.* FROM " .$pre."goods as g $where";
        $sql .= " LIMIT ". (($data["p"] - 1) * $data["page_size"]). ", ".$data["page_size"];

        $data["list"] = M()->query($sql);

        $smo=M('test')->where("id='%d'",array( $data["orderid"]))->find();
        $model=M("test_detail");
        $sm=M('stock2');
        $storage=M('storage')->where("code='%s'",array($smo['storage_code']))->find();


        foreach ($data["list"] as $k=>$v) {
            $stock=$sm->where("storage_id='%d' AND goods_id='%d' ",array($storage['id'],$v['id']))->find();
            $data['list'][$k]['sctok']=floatval($stock['qty']);
            $smd=$model->where("test_id='%d' AND goods_id='%d' ",array($data["orderid"],$v['id']))->find();
            $data['list'][$k]['qty']=floatval($smd['qty']);
        }

        $pageClass = new \Think\Page($count,$data["page_size"]);
        $pageClass->rollPage = 8;
        $data["page"] = $pageClass->show_drp($data["funcid"], "编辑商品信息");

        $categroy_list = M("category")->where("parent_id = 0")->select();
        $clist = array();
        foreach($categroy_list as $category) {
            $clist[$category["id"]]["main"] = $category;
            $clist[$category["id"]]["detail"] = M("category")->where("parent_id = ".$category["id"])->select();
        }

        $data["categorys"] = $clist;

        foreach($data as $key=>$val) {
            $this->assign($key, $val);
        }
        $html = $this->fetch("Test:selectProduct");
        echo $html;
    }

    private function saveSelectProduct($data) {
        $orderid = I("request.orderid");
        $close = I("request.close");

        $id= I("id");
        $model=M("test_detail");
        $smo=M('test')->where("id='%d'",array($orderid))->find();
        if(empty($smo)) {
            $this->ajaxResult("测试信息不存在");
        }
        $sm=M('stock2');
        $gm=M('goods');

        $model->startTrans();
        $result=false;
        foreach ($id  as $k=>$v)
        {
            $g=$gm->where("id='%d'",$v)->find();

            $qty=floatval(I("qty_".$v));
            $storage_location = I("storage_location_".$v);

            $smd=$model->where("test_id='%d' AND goods_id='%d' ",array($orderid,$v))->find();

            $cur_data=array();
            $cur_data['goods_id']=$v;
            $cur_data['test_id']=$orderid;
            $cur_data['order_no']=$smo['order_no'];
            $cur_data['qty']=$qty;
            $cur_data['order_qty']=$qty;
            $cur_data['price']=I("price_".$v);
            $cur_data['amount']=$cur_data['price']*abs($qty);
            $cur_data['goods_no']=$g['goods_no'];
            $cur_data['goods_name']=$g['name'];
            $cur_data['brand_code']=$g['brand_code'];
            $cur_data['style_info']=$g['style_info'];
            $cur_data['barcode']=$g['barcode'];
            $cur_data['location_code']=$storage_location;
            $cur_data['storage_code']=$smo["storage_code"];

            if(!empty($smd)){
                $result =  $model->where("test_id='%d' AND goods_id='%d'",array($orderid,$v))->save($cur_data);
            }else{
                $result =  $model->add($cur_data);

            }

            if(!$result){
                break;
            }

        }

        $qty_total=$model->where("test_id='%d'",array($orderid))->field("SUM(qty) qty_total,SUM(amount) amount_total")->find();

        $result2=M('test')->where("id='%d'",array($orderid))->save(array('qty'=>$qty_total['qty_total'],'amount'=>$qty_total['amount_total'],'modify_time'=>date('Y-m-d H:i:s'),'modify_user'=>session(C("USER_AUTH_KEY"))));

        $sa=M('test')->where("id='%d'",array($orderid))->find();

        if($sa['status']!=0){
            $result2=false;
        }

        if($result && $result2){
            $model->commit();
        }else{
            $model->rollback();
        }

        if($close == "1") {
            $this->ajaxResult("", "",  array("_asr.closePopup", "_asr.openLink"), array("'".$data["funcid"]."'", "'','".$data["pfuncid"]."','刷新', 1"));
        } else {
            $this->ajaxResult("", "",  array("_asr.openLink"), array("'','".$data["pfuncid"]."','刷新', 1"));
        }

        die;
    }

}
